
[[#Агрегатные функции]]
[[#Ранжирующие функции]]
[[#Функции смещения]]
	[[#LAG()]]
	[[#FIRST_VALUE(), LAST_VALUE()]]
[[#Аналитические функции]]
	[[#ROW_NUMBER()]]
[[#Операторы]]
	[[#OVER]]
	[[#PARTITION]]

Оконные функции в SQL — это мощный инструмент, который позволяет выполнять сложные вычисления над группами строк, связанных с текущей строкой. Они сохраняют исходные строки и добавляют к ним результаты вычислений, что отличает их от агрегатных функций, которые группируют строки в одну строку результата.

Оконные функции работают с набором строк, называемым «окном», и выполняют вычисления для каждой строки в этом окне. Они определяются с помощью предложения `OVER()`, которое позволяет задать порядок и партиционирование строк.

## Агрегатные функции

Эти функции вычисляют агрегированные значения для набора строк, но в отличие от обычных агрегатных функций, они возвращают результат для каждой строки, а не сводят все строки в одну.

`SUM()`, `MAX()`, `MIN()`, `AVG()`, `COUNT()`

```SQL
SELECT sale_date, sales_amount,
       SUM(sales_amount) OVER (ORDER BY sale_date ROWS BETWEEN 6 PRECEDING AND CURRENT ROW) AS rolling_sum
FROM sales;
/*
ROWS BETWEEN 6 PRECEDING AND CURRENT ROW - строки между шестью предыдущими и текущей строкой
*/
```

## Ранжирующие функции

Используются для присвоения рангов или номеров строкам на основе определенного порядка.

Если две или более строки имеют одинаковое значение, они получат одинаковый ранг, а следующая строка получит ранг, который на единицу больше, чем количество ранжированных строк с одинаковым значением.

`ROW_NUMBER()`, `RANK()`, `DENSE_RANK()`

```SQL
SELECT employee_id, salary,
       RANK() OVER (ORDER BY salary DESC) AS salary_rank
FROM employees;
```

## Функции смещения

Позволяют обращаться к значениям в предыдущих или последующих строках относительно текущей строки.

`LAG()`, `LEAD()`, `FIRST_VALUE()`, `LAST_VALUE()`.

### LAG()

```SQL
SELECT employee_id, salary,
       LAG(salary) OVER (ORDER BY employee_id) AS previous_salary
FROM employees;
/*
Возвращает значение зарплаты из предыдущей строки. Если не указано смещение, по умолчанию используется смещение 1, то есть возвращает значение из строки, непосредственно предшествующей текущей.
*/
```

### FIRST_VALUE(), LAST_VALUE()

```SQL
SELECT employee_id, salary,
       FIRST_VALUE(salary) OVER (PARTITION BY employee_id ORDER BY date) AS first_salary,
       LAST_VALUE(salary) OVER (PARTITION BY employee_id ORDER BY date) AS last_salary
FROM salaries;
/*
FIRST_VALUE() и LAST_VALUE() нужны для получения первой и последней зарплаты каждого сотрудника на основе даты.
*/
```

## Аналитические функции

Используются для вычислений на основе движущегося окна строк, например, для расчета скользящих средних или кумулятивных сумм.

### ROW_NUMBER()

Функция `ROW_NUMBER()` в SQL используется для присвоения уникального номера каждой строке в результирующем наборе данных. Она часто применяется в аналитических запросах, где необходимо упорядочить строки и получить номер каждой строки в зависимости от заданного порядка.

```SQL
ROW_NUMBER() OVER (PARTITION BY column1, column2, ... ORDER BY column1 [ASC|DESC], column2 [ASC|DESC])
```

- **PARTITION BY** (необязательный): Делит результирующий набор на группы, для каждой из которых функция `ROW_NUMBER` будет вычислена независимо. Если не указано, все строки обрабатываются как одна группа.
- **ORDER BY** (обязательный): Определяет порядок, в котором строкам назначаются номера. Это определяет, как будет происходить нумерация строк.

```SQL
SELECT employee_id, salary, 
       ROW_NUMBER() OVER (ORDER BY salary DESC) AS RowNum
FROM Employees;
```

- **Уникальность номеров:** В отличие от функций `RANK` и `DENSE_RANK`, функция `ROW_NUMBER` всегда присваивает уникальный номер каждой строке, даже если значения в упорядочиваемом столбце совпадают. Например, если два сотрудника имеют одинаковую зарплату, один из них получит номер 1, а другой — 2.
- **Применение в пагинации:** Функция `ROW_NUMBER()` часто используется для реализации пагинации результатов. Например, чтобы получить определенную страницу результатов:

## Операторы

Вместе с оконными функциями используются операторы, которые разберем в этом блоке.

### OVER

Функция `ROW_NUMBER()` всегда используется в сочетании с предложением `OVER()`. Предложение `OVER()` определяет порядок и партиционирование строк, для которых функция `ROW_NUMBER()` присваивает уникальные номера. В `OVER()` можно указать `PARTITION BY` для группировки строк и `ORDER BY` для определения порядка нумерации.

Предложение `OVER` в SQL используется для определения окна или набора строк, для которых применяется оконная функция. Оно позволяет указать, как строки будут секционированы и упорядочены перед применением функции.

### PARTITION

Предложение `PARTITION BY` в SQL используется для разделения результирующего набора данных на группы или партиции на основе одного или нескольких столбцов. Это позволяет применять оконные функции к каждой группе отдельно, что особенно полезно для аналитических вычислений.

1. **Разделение на группы:**  
    `PARTITION BY` разделяет строки на подмножества на основе указанных столбцов. Все строки с одинаковыми значениями в этих столбцах будут относиться к одной группе.
2. **Применение оконных функций:**  
    Окнные функции, такие как `SUM`, `AVG`, `ROW_NUMBER`, `RANK`, применяются к каждой группе отдельно. Это позволяет выполнять вычисления внутри каждой партиции независимо от других.

```SQL
SELECT type, object_id,
       MIN(object_id) OVER (PARTITION BY type) AS min_id
FROM sys.objects;
```
